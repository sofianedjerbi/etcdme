apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Inherit from base
resources:
  - ../../base

# KSOPS generator for SOPS-encrypted secrets
# ArgoCD decrypts via KSOPS plugin, kubectl skips this
generators:
  - ksops-generator.yaml

# Domain configuration
configMapGenerator:
  - name: cluster-config
    namespace: default
    literals:
      - domain=etcd.me
      - repo-url=https://github.com/sofianedjerbi/homelab
      - overlay-path=argocd/overlays/etcdme-nbg1-dc3
      - gateway-path=argocd/overlays/etcdme-nbg1-dc3/resources/gateway

# Repository configuration - replace placeholders only in apps that use them
replacements:
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.repo-url
    targets:
      - select:
          kind: Application
          name: root-app
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: cilium-gateway
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: postgres-cluster
        fieldPaths:
          - spec.source.repoURL
      - select:
          kind: Application
          name: argocd-routes
        fieldPaths:
          - spec.source.repoURL
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.overlay-path
    targets:
      - select:
          kind: Application
          name: root-app
        fieldPaths:
          - spec.source.path
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.gateway-path
    targets:
      - select:
          kind: Application
          name: cilium-gateway
        fieldPaths:
          - spec.source.path

# Patches to replace domain in various resources
# Note: Gateway patches are in overlays/etcdme-nbg1-dc3/resources/gateway/kustomization.yaml
patches:
  # Routes
  - target:
      kind: TLSRoute
      name: argocd-tls-route
    patch: |
      - op: replace
        path: /spec/hostnames/0
        value: argo.etcd.me

  - target:
      kind: HTTPRoute
      name: grafana-route
    patch: |
      - op: replace
        path: /spec/hostnames/0
        value: loki.etcd.me

  - target:
      kind: HTTPRoute
      name: keycloak-route
    patch: |
      - op: replace
        path: /spec/hostnames/0
        value: auth.etcd.me

  # Keycloak instance - hostname
  - target:
      kind: Keycloak
      name: keycloak
    patch: |
      - op: replace
        path: /spec/hostname/hostname
        value: auth.etcd.me

# Files that are too complex to patch - override entirely
  - path: realm-import.yaml
  - path: loki-stack-app.yaml
  - path: argocd-app.yaml
  - path: cluster-issuer.yaml
