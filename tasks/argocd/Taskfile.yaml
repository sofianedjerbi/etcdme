version: '3'

vars:
  OVERLAY: etcdme-nbg1-dc3
  REPO_URL: https://github.com/sofianedjerbi/homelab

tasks:
  generate-secrets:
    desc: Generate secrets file (requires AWS_* and SOPS_AGE_KEY env vars)
    cmds:
      - ./tasks/scripts/generate-secrets.sh {{.OVERLAY}}

  bootstrap:
    desc: Bootstrap ArgoCD (run once after cluster creation)
    cmds:
      - echo "Creating namespaces..."
      - |
        for ns in argocd cert-manager keycloak postgres monitoring; do
          kubectl create namespace $ns --dry-run=client -o yaml | kubectl apply -f -
        done
      - echo "Applying secrets..."
      - sops -d argocd/overlays/{{.OVERLAY}}/secrets.sops.yaml | kubectl apply -f -
      - echo "Installing ArgoCD via Helmfile..."
      - helmfile -f argocd/helmfile.yaml apply
      - echo "Applying root application..."
      - |
        sed -e 's|REPO_URL_PLACEHOLDER|{{.REPO_URL}}|' \
            -e 's|OVERLAY_PATH_PLACEHOLDER|argocd/overlays/{{.OVERLAY}}|' \
            argocd/base/apps/root-app.yaml | kubectl apply -f -
      - echo "âœ… ArgoCD bootstrapped! Sync will start automatically."

  password:
    desc: Get ArgoCD admin password
    cmds:
      - kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d && echo

  secrets:
    desc: Print decrypted secrets from SOPS file
    cmds:
      - sops -d argocd/overlays/{{.OVERLAY}}/secrets.sops.yaml

  keycloak-admin:
    desc: Get Keycloak admin credentials
    cmds:
      - echo "=== Keycloak Admin Credentials ==="
      - echo "URL: https://auth.etcd.me"
      - echo -n "Username: " && kubectl -n keycloak get secret keycloak-initial-admin -o jsonpath="{.data.username}" | base64 -d && echo
      - echo -n "Password: " && kubectl -n keycloak get secret keycloak-initial-admin -o jsonpath="{.data.password}" | base64 -d && echo
      - echo ""
      - echo "To get OIDC client secrets:"
      - echo "  1. Login to Keycloak admin console"
      - echo "  2. Switch to 'homelab' realm"
      - echo "  3. Go to Clients > argocd/grafana > Credentials tab"

  grafana-admin:
    desc: Get Grafana admin credentials
    cmds:
      - echo "=== Grafana Admin Credentials ==="
      - echo "URL: https://loki.etcd.me"
      - echo -n "Username: " && kubectl -n monitoring get secret grafana-admin -o jsonpath="{.data.admin-user}" | base64 -d && echo
      - echo -n "Password: " && kubectl -n monitoring get secret grafana-admin -o jsonpath="{.data.admin-password}" | base64 -d && echo

  post-bootstrap:
    desc: Show all credentials needed for post-bootstrap setup
    cmds:
      - task: keycloak-admin
      - echo ""
      - task: grafana-admin
      - echo ""
      - task: password
      - echo ""
      - echo "=== Post-Bootstrap Steps ==="
      - echo "1. Get OIDC client secrets from Keycloak (see keycloak-admin above)"
      - echo "2. Update secrets: sops -d -i argocd/overlays/{{.OVERLAY}}/secrets.sops.yaml"
      - echo "3. Replace REPLACE_WITH_KEYCLOAK_SECRET with actual values"
      - echo "4. Re-encrypt: sops -e -i argocd/overlays/{{.OVERLAY}}/secrets.sops.yaml"
      - echo "5. Commit and push to trigger ArgoCD sync"
